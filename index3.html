<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KAM Registar</title>

  <!-- Fontovi i DataTables -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400&family=Rubik:wght@300&display=swap" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"/>
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

  <!-- Tvoj CSS -->
  <link rel="stylesheet" type="text/css" href="style.css">

  <style>
    /* Osnovni izgled tablica za prikaz (klasa, svojstva) */
    #classTable, #propsTable {
      width:100%;
      border-collapse: collapse;
    }
    #classTable td, #propsTable td, #propsTable th {
      padding:8px;
      border:1px solid #ddd;
    }
    #classTable tr:first-child td,
    #propsTable tr:first-child td,
    #propsTable tr:first-child th {
      border-top:1px solid #ddd;
    }
    #classTable tr:last-child td,
    #propsTable tr:last-child td {
      border-bottom:1px solid #ddd;
    }
    #classTable td:first-child {
      width:18%;
      font-weight:bold;
    }

    /* Dropdown linkovi da budu normalno kliktabilni */
    #menu-bar .dropdown a {
      display:block;
      padding:6px 10px;
      text-decoration:none;
      color:inherit;
      cursor:pointer;
    }
    #menu-bar .dropdown a:hover { background:#f3f3f3; }
    #menu-bar .dropdown { z-index:1000; }
  </style>
</head>
<body>

<!-- Gornji meni -->
<div id="menu-bar">
  <img src="kam.png" alt="KAM Logo" class="logo">
  <h1>Registar</h1>

  <div>
    KLASE
    <div class="dropdown" id="klase-dropdown"></div>
  </div>

  <div>
    SVOJSTVA
    <div class="dropdown" id="svojstva-dropdown"></div>
  </div>

  <div id="prefiksi">PREFIKSI</div>

  <div><a href="index.html?section=pomoc">Pomoć</a></div>
</div>

<!-- Glavni sadržaj -->
<div id="content">
  <h2>O registru</h2>
  <p>Ovdje ide tvoj uvodni tekst o KAM registru, ontologiji, načinu korištenja itd.</p>
</div>

<!-- Footer -->
<div id="footer">
  © 2024 Nacionalna i sveučilišna knjižnica u Zagrebu. Sva prava pridržana. | Hrvatske bratske zajednice 4, 10000 Zagreb, Hrvatska | Tel. +385 1 616 4021
</div>

<script>
/* ----------------- POMOĆNE FUNKCIJE ----------------- */
function getGraph(data){
  return Array.isArray(data) ? data : (data['@graph'] || []);
}

function makeClickableLink(uri) {
  return uri ? `<a href="${uri}" target="_blank" rel="noopener">${uri}</a>` : '';
}

/* ----------------- POPUNJAVANJE MENIJA ----------------- */

function populateKlaseDropdown(data) {
  const graph = getGraph(data);
  const dd = document.getElementById('klase-dropdown');
  if (!dd) return;
  dd.innerHTML = '';

  graph.forEach(el => {
    const types = el['@type'] || [];
    const isClass = types.includes('http://www.w3.org/2002/07/owl#Class');
    if (!isClass) return;

    const labels = el['http://www.w3.org/2000/01/rdf-schema#label'] || [];
    const hr = labels.find(l => l['@language'] === 'hr');
    const name = (hr && hr['@value']) ||
                 (labels[0] && labels[0]['@value']) ||
                 (el['@id'] || '').split('/').pop();

    const a = document.createElement('a');
    // klik na KLASE na indexu: odmah ovdje prikaži detalje klase
    a.textContent = name;
    a.onclick = (evt) => {
      evt.preventDefault();
      displayClassDetails(el, data);
      // ažuriraj URL (bez reloada) da znaš o kojoj se klasi radi
      const url = new URL(window.location);
      url.searchParams.set('class', el['@id']);
      url.searchParams.delete('section');
      window.history.replaceState({}, '', url);
    };
    dd.appendChild(a);
  });
}

function populateSvojstvaDropdown(data) {
  const graph = getGraph(data);
  const dd = document.getElementById('svojstva-dropdown');
  if (!dd) return;
  dd.innerHTML = '';

  graph.forEach(el => {
    const isClass = (el['@type'] || []).includes('http://www.w3.org/2002/07/owl#Class');
    if (!isClass) return;

    const labels = el['http://www.w3.org/2000/01/rdf-schema#label'] || [];
    const hr = labels.find(l => l['@language'] === 'hr');
    const name = (hr && hr['@value']) ||
                 (labels[0] && labels[0]['@value']) ||
                 (el['@id'] || '').split('/').pop();

    const a = document.createElement('a');
    // klik na SVOJSTVA: prikaži listu svojstava za tu klasu
    a.textContent = name;
    a.onclick = (evt) => {
      evt.preventDefault();
      displayPropertiesForClass(el['@id'], data, name);
      const url = new URL(window.location);
      url.searchParams.set('class', el['@id']);
      url.searchParams.set('section', 'svojstva');
      window.history.replaceState({}, '', url);
    };
    dd.appendChild(a);
  });
}

function populatePrefiksi(data){
  const btn = document.getElementById('prefiksi');
  if (!btn) return;
  btn.onclick = () => {
    const graph = getGraph(data);
    const unique = new Map();
    graph.forEach(el => {
      const curie = el['http://www.registar.kam.hr/ontologies/ont.owl/ID']?.[0]?.['@value'];
      if (!curie || !curie.includes(':')) return;
      const prefix = curie.split(':')[0];
      const id = el['@id'] || '';
      const ns = id.includes('/') ? id.slice(0, id.lastIndexOf('/') + 1) : '';
      if (!unique.has(prefix)) unique.set(prefix, { ns, count: 0 });
      unique.get(prefix).count += 1;
    });

    let html = `<h2>Prefiksi</h2>
      <table class="display" id="prefixTable">
        <thead><tr><th>Prefiks</th><th>Imenski prostor</th><th>Broj elemenata</th></tr></thead><tbody>`;
    Array.from(unique.keys()).sort().forEach(p=>{
      const {ns,count} = unique.get(p);
      html += `<tr><td>${p}</td><td>${ns}</td><td>${count}</td></tr>`;
    });
    html += `</tbody></table>`;
    const content = document.getElementById('content');
    content.innerHTML = html;
    $(document).ready(()=> $('#prefixTable').DataTable({paging:false, searching:false, info:false}));
  };
}

/* ----------------- PRIKAZ KLASA I SVOJSTAVA ----------------- */

function displayClassDetails(element, data) {
  const content = document.getElementById('content');
  const classId = element['@id'];

  const labels = element['http://www.w3.org/2000/01/rdf-schema#label'] || [];
  const hr = labels.find(l => l['@language']==='hr');
  const name = (hr && hr['@value']) ||
               (labels[0] && labels[0]['@value']) ||
               classId.split('/').pop();

  const comment = element['http://www.w3.org/2000/01/rdf-schema#comment']?.[0]?.['@value'] || '';

  const superClass = element['http://www.w3.org/2000/01/rdf-schema#subClassOf']?.[0]?.['@id'] || '';

  // Podklase: svi elementi kojima je subClassOf = classId
  const graph = getGraph(data);
  const subClasses = graph.filter(el => {
    const sc = el['http://www.w3.org/2000/01/rdf-schema#subClassOf'] || [];
    return sc.some(s => s['@id'] === classId);
  });

  const subList = subClasses.map(sc => {
    const lbls = sc['http://www.w3.org/2000/01/rdf-schema#label'] || [];
    const hr2 = lbls.find(l => l['@language']==='hr');
    const nm = (hr2 && hr2['@value']) ||
               (lbls[0] && lbls[0]['@value']) ||
               (sc['@id'] || '').split('/').pop();
    return nm;
  });

  content.innerHTML = `
    <h2>Klasa: "${name}"</h2>
    <table id="classTable" class="display">
      <tbody>
        <tr><td>@id</td><td>${makeClickableLink(classId)}</td></tr>
        <tr><td>Opis</td><td>${comment}</td></tr>
        <tr><td>Nadklasa</td><td>${makeClickableLink(superClass)}</td></tr>
        <tr><td>Podklase</td><td>${subList.length ? subList.join(', ') : 'Nema podklasa.'}</td></tr>
      </tbody>
    </table>
  `;
  $(document).ready(()=> $('#classTable').DataTable({paging:false, info:false, searching:false, ordering:false}));
}

function displayPropertiesForClass(classId, data, classLabel) {
  const content = document.getElementById('content');
  const graph = getGraph(data);
  const propTypes = [
    'http://www.w3.org/2002/07/owl#ObjectProperty',
    'http://www.w3.org/2002/07/owl#DatatypeProperty',
    'http://www.w3.org/2002/07/owl#AnnotationProperty'
  ];

  const props = graph.filter(el => {
    const types = el['@type'] || [];
    const isProp = types.some(t => propTypes.includes(t));
    const domains = el['http://www.w3.org/2000/01/rdf-schema#domain'] || [];
    return isProp && domains.some(d => d['@id'] === classId);
  });

  let html = `<h2>Svojstva za klasu: "${classLabel || classId.split('/').pop()}"</h2>
  <table class="display" id="propsTable">
    <thead><tr><th>KAM ID</th><th>Naziv</th><th>Domena</th></tr></thead><tbody>`;

  props.forEach(p => {
    const labels = p['http://www.w3.org/2000/01/rdf-schema#label'] || [];
    const hr = labels.find(l => l['@language']==='hr');
    const name = (hr && hr['@value']) ||
                 (labels[0] && labels[0]['@value']) ||
                 (p['@id']||'').split('/').pop();
    const curie = p['http://www.registar.kam.hr/ontologies/ont.owl/ID']?.[0]?.['@value'] || '';
    const domId = p['http://www.w3.org/2000/01/rdf-schema#domain']?.[0]?.['@id'] || '';
    html += `<tr>
      <td>${curie}</td>
      <td>${name}</td>
      <td>${makeClickableLink(domId)}</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  content.innerHTML = html;
  $(document).ready(()=> $('#propsTable').DataTable({paging:false, info:false, searching:false}));
}

/* ----------------- INICIJALIZACIJA ----------------- */

(function init(){
  fetch('KAMOntologija_v12.jsonld')   /* koristi isti naziv kao i property.html */
    .then(response => {
      if (!response.ok) throw new Error('Greška pri dohvaćanju ontologije');
      return response.json();
    })
    .then(data => {
      // 1) Napuni dropdown menije
      populateKlaseDropdown(data);
      populateSvojstvaDropdown(data);
      populatePrefiksi(data);

      // 2) Pogledaj URL parametre (da radi kad dođeš s property.html)
      const urlParams = new URLSearchParams(window.location.search);
      const classId = urlParams.get('class');
      const section = urlParams.get('section');

      if (classId) {
        const graph = getGraph(data);
        const element = graph.find(el => el['@id'] === classId);
        if (element) {
          const labels = element['http://www.w3.org/2000/01/rdf-schema#label'] || [];
          const hr = labels.find(l => l['@language']==='hr');
          const classLabel = (hr && hr['@value']) ||
                             (labels[0] && labels[0]['@value']) ||
                             classId.split('/').pop();

          if (section === 'svojstva') {
            displayPropertiesForClass(classId, data, classLabel);
          } else {
            displayClassDetails(element, data);
          }
        }
      }
    })
    .catch(err => {
      console.error('Ne mogu dohvatiti KAM ontologiju:', err);
      document.getElementById('content').innerHTML =
        '<p>Pogreška u dohvaćanju ontologije. Provjerite putanju do KAMOntologija_v12.jsonld.</p>';
    });
})();
</script>

</body>
</html>
