<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KAM Ontology Property</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400&family=Rubik:wght@300&display=swap" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"/>
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" type="text/css" href="style.css">

  <style>
    #propertyTable { width:100%; border-collapse: collapse; }
    #propertyTable td { padding:8px; border:1px solid #ddd; }
    #propertyTable tr:first-child td { border-top:1px solid #ddd; }
    #propertyTable tr:last-child  td { border-bottom:1px solid #ddd; }
    #propertyTable td:first-child { width:18%; font-weight:bold; }

    /* stabilan klik u dropdownu */
    #menu-bar .dropdown a {
      display:block;
      padding:6px 10px;
      text-decoration:none;
      color:inherit;
      cursor:pointer;
    }
    #menu-bar .dropdown a:hover { background:#f3f3f3; }
    #menu-bar .dropdown { z-index:1000; }
  </style>
</head>
<body>

<!-- NAV: isti markup kao na indexu -->
<div id="menu-bar">
  <img src="kam.png" alt="KAM Logo" class="logo">
  <h1><a href="index.html" style="text-decoration:none; color:inherit;">Registar</a></h1>

  <div>
    KLASE
    <div class="dropdown" id="klase-dropdown"></div>
  </div>

  <div>
    SVOJSTVA
    <div class="dropdown" id="svojstva-dropdown"></div>
  </div>

  <!-- PREFIKSI nije dropdown; klik crta tablicu u #content -->
  <div id="prefiksi">PREFIKSI</div>

  <div><a href="index.html" onclick="redirectToIndex('pomoc'); return false;">Pomoć</a></div>
</div>

<div id="content">
  <p>Detalji za entitet.</p>
</div>

<div id="footer">
  © 2024 Nacionalna i sveučilišna knjižnica u Zagrebu. Sva prava pridržana. | Hrvatske bratske zajednice 4, 10000 Zagreb, Hrvatska | Tel. +385 1 616 4021
</div>

<script>
/* ----------------- UTIL ----------------- */
function redirectToIndex(section) {
  const urlParams = new URLSearchParams(window.location.search);
  const curie = urlParams.get('curie') || '';
  window.location.href = `index.html?section=${encodeURIComponent(section)}&curie=${encodeURIComponent(curie)}`;
}

function getGraph(data){
  return Array.isArray(data) ? data : (data['@graph'] || []);
}

function makeClickableLink(uri) {
  return uri ? `<a href="${uri}" target="_blank" rel="noopener">${uri}</a>` : '';
}

function isLocalStorageAvailable() {
  try { const t='__ls__'; localStorage.setItem(t,t); localStorage.removeItem(t); return true; }
  catch(e){ return false; }
}

/* ----------------- DROPDOWNI (ISTE STAVKE − KLASE) ----------------- */
function populateKlaseDropdown(data) {
  const graph = getGraph(data);
  const dd = document.getElementById('klase-dropdown');
  if (!dd) return;
  dd.innerHTML = '';

  graph.forEach(el => {
    const isClass = (el['@type'] || []).includes('http://www.w3.org/2002/07/owl#Class');
    if (!isClass) return;

    const labels = el['http://www.w3.org/2000/01/rdf-schema#label'] || [];
    const hr = labels.find(l => l['@language'] === 'hr');
    const name = (hr && hr['@value']) || (labels[0] && labels[0]['@value']) || (el['@id']||'').split('/').pop();

	const a = document.createElement('a');
	// NOVO: vodi na index.html
	a.href = `index.html?class=${encodeURIComponent(el['@id'])}`;
	a.textContent = name;
	dd.appendChild(a);

  });
}

function populateSvojstvaDropdown(data) {
  const graph = getGraph(data);
  const dd = document.getElementById('svojstva-dropdown');
  if (!dd) return;
  dd.innerHTML = '';

  graph.forEach(el => {
    const isClass = (el['@type'] || []).includes('http://www.w3.org/2002/07/owl#Class');
    if (!isClass) return;

    const labels = el['http://www.w3.org/2000/01/rdf-schema#label'] || [];
    const hr = labels.find(l => l['@language'] === 'hr');
    const name = (hr && hr['@value']) || (labels[0] && labels[0]['@value']) || (el['@id']||'').split('/').pop();

    const a = document.createElement('a');
    // ➜ lista svojstava te klase NA property.html
    a.href = `property.html?section=svojstva&class=${encodeURIComponent(el['@id'])}`;
    a.textContent = name;
    dd.appendChild(a);
  });
}

function wirePrefiksiClick(data){
  const btn = document.getElementById('prefiksi');
  if (!btn) return;
  btn.onclick = () => {
    const graph = getGraph(data);
    const unique = new Map();
    graph.forEach(el => {
      const curie = el['http://www.registar.kam.hr/ontologies/ont.owl/ID']?.[0]?.['@value'];
      if (!curie || !curie.includes(':')) return;
      const prefix = curie.split(':')[0];
      const id = el['@id'] || '';
      const ns = id.includes('/') ? id.slice(0, id.lastIndexOf('/') + 1) : '';
      if (!unique.has(prefix)) unique.set(prefix, { ns, count: 0 });
      unique.get(prefix).count += 1;
    });

    let html = `<h2>Prefiksi</h2>
      <table class="display" id="prefixTable">
        <thead><tr><th>Prefiks</th><th>Imenski prostor</th><th>Broj elemenata</th></tr></thead><tbody>`;
    Array.from(unique.keys()).sort().forEach(p=>{
      const {ns,count} = unique.get(p);
      html += `<tr><td>${p}</td><td>${ns}</td><td>${count}</td></tr>`;
    });
    html += `</tbody></table>`;
    const content = document.getElementById('content');
    content.innerHTML = html;
    $(document).ready(()=> $('#prefixTable').DataTable({paging:false, searching:false, info:false}));
  };
}

/* ----------------- DETALJI SVOJSTVA ----------------- */
function generateDownloadLinks(curie) {
  const className = (curie.split(':')[1] || '').toLowerCase().replace(/ /g, '_');
  const jsonLdLink = `ontology_elements_${className}.jsonld`;
  const csvLink    = `ontology_elements_${className}.csv`;
  const rdfXmlLink = `ontology_elements_${className}.rdf`;
  return `
    <table>
      <tr>
        <td>Preuzimanja:</td>
        <td><a href="${jsonLdLink}" download>JSON-LD</a></td>
        <td><a href="${csvLink}"    download>CSV</a></td>
        <td><a href="${rdfXmlLink}" download>RDF/XML</a></td>
      </tr>
    </table>`;
}

function getLastModifiedDate() {
  return `<table><tr><td>Posljednja izmjena: ${document.lastModified}</td></tr></table>`;
}

function displayPropertyDetails(curie, data) {
  const content = document.getElementById('content');
  const graph = getGraph(data);
  const property = graph.find(item =>
    item['http://www.registar.kam.hr/ontologies/ont.owl/ID']
    && item['http://www.registar.kam.hr/ontologies/ont.owl/ID'][0]['@value'] === curie
  );

  if (!property) {
    content.innerHTML = '<p>Detalji nisu pronađeni za zadani CURIE.</p>';
    return;
  }

  const label = property['http://www.w3.org/2000/01/rdf-schema#label']?.[0]?.['@value'] || '';
  const definition = property['http://www.registar.kam.hr/ontologies/ont.owl/definition']?.[0]?.['@value'] || '';
  const domain = property['http://www.w3.org/2000/01/rdf-schema#domain']?.[0]?.['@id'] || '';
  const range  = property['http://www.w3.org/2000/01/rdf-schema#range']?.[0]?.['@id'] || '';
  const subPropertyOf = property['http://www.w3.org/2000/01/rdf-schema#subPropertyOf']?.[0]?.['@id'] || '';
  const inverseOf = property['http://www.w3.org/2002/07/owl#inverseOf']?.[0]?.['@id'];

  content.innerHTML = `<h2>Detalji za: "${label}"</h2>`;
  let table = `
    <table id="propertyTable" class="display">
      <tbody>
        <tr><td>KAM ID</td><td>${curie}</td></tr>
        <tr><td>Naziv</td><td>${label}</td></tr>
        <tr><td>Definicija</td><td>${definition}</td></tr>
        <tr><td>Domena</td><td>${makeClickableLink(domain)}</td></tr>
        <tr><td>Doseg</td><td>${makeClickableLink(range)}</td></tr>
        <tr><td>Obrnuto od</td><td>${inverseOf ? makeClickableLink(inverseOf) : 'Ne postoji <i>inverseOf</i>'}</td></tr>
        <tr><td>Podsvojstvo od</td><td>${makeClickableLink(subPropertyOf)}</td></tr>
      </tbody>
    </table>`;
  content.innerHTML += table;
  content.innerHTML += generateDownloadLinks(curie);
  content.innerHTML += getLastModifiedDate();

  $(document).ready(()=> $('#propertyTable').DataTable({paging:false, info:false, searching:false, ordering:false}));
}

/* ----------------- PRIKAZ KLASE & LISTE SVOJSTAVA ----------------- */
function displayClassDetails(classId, data) {
  const content = document.getElementById('content');
  const graph = getGraph(data);
  const cls = graph.find(el => el['@id'] === classId);
  if (!cls) { content.innerHTML = '<p>Klasa nije pronađena.</p>'; return; }

  const labels = cls['http://www.w3.org/2000/01/rdf-schema#label'] || [];
  const hr = labels.find(l => l['@language']==='hr');
  const name = (hr && hr['@value']) || (labels[0] && labels[0]['@value']) || classId.split('/').pop();

  const comment = cls['http://www.w3.org/2000/01/rdf-schema#comment']?.[0]?.['@value'] || '';
  const superClass = cls['http://www.w3.org/2000/01/rdf-schema#subClassOf']?.[0]?.['@id'] || '';

  content.innerHTML = `
    <h2>Klasa: "${name}"</h2>
    <table id="classTable" class="display">
      <tbody>
        <tr><td>@id</td><td>${makeClickableLink(classId)}</td></tr>
        <tr><td>Opis</td><td>${comment}</td></tr>
        <tr><td>Nadklasa</td><td>${makeClickableLink(superClass)}</td></tr>
      </tbody>
    </table>
  `;
  $(document).ready(()=> $('#classTable').DataTable({paging:false, info:false, searching:false, ordering:false}));
}

function displayPropertiesForClassOnPropertyPage(classId, data) {
  const content = document.getElementById('content');
  const graph = getGraph(data);
  const propTypes = [
    'http://www.w3.org/2002/07/owl#ObjectProperty',
    'http://www.w3.org/2002/07/owl#DatatypeProperty',
    'http://www.w3.org/2002/07/owl#AnnotationProperty'
  ];

  const props = graph.filter(el => {
    const types = el['@type'] || [];
    const isProp = types.some(t => propTypes.includes(t));
    const domains = el['http://www.w3.org/2000/01/rdf-schema#domain'] || [];
    return isProp && domains.some(d => d['@id'] === classId);
  });

  // Naziv klase (za naslov)
  const cls = graph.find(el => el['@id'] === classId);
  const clsLabel = cls?.['http://www.w3.org/2000/01/rdf-schema#label']?.[0]?.['@value'] || classId.split('/').pop();

  let html = `<h2>Svojstva za klasu: "${clsLabel}"</h2>
  <table class="display" id="propsTable">
    <thead><tr><th>KAM ID</th><th>Naziv</th><th>Domena</th><th>Akcija</th></tr></thead><tbody>`;

  props.forEach(p => {
    const labels = p['http://www.w3.org/2000/01/rdf-schema#label'] || [];
    const hr = labels.find(l => l['@language']==='hr');
    const name = (hr && hr['@value']) || (labels[0] && labels[0]['@value']) || (p['@id']||'').split('/').pop();
    const curie = p['http://www.registar.kam.hr/ontologies/ont.owl/ID']?.[0]?.['@value'] || '';
    const domId = p['http://www.w3.org/2000/01/rdf-schema#domain']?.[0]?.['@id'] || '';
    html += `<tr>
      <td>${curie}</td>
      <td>${name}</td>
      <td>${makeClickableLink(domId)}</td>
      <td><a href="property.html?curie=${encodeURIComponent(curie)}">Otvori svojstvo</a></td>
    </tr>`;
  });

  html += `</tbody></table>`;
  content.innerHTML = html;
  $(document).ready(()=> $('#propsTable').DataTable({paging:false, info:false, searching:false}));
}

/* ----------------- BOOTSTRAP ----------------- */
let ontologyDataGlobal = null;
const urlParams = new URLSearchParams(window.location.search);
const curie = urlParams.get('curie');
const classId = urlParams.get('class');
const section = urlParams.get('section');

function bootstrap(data){
  ontologyDataGlobal = data;
  populateKlaseDropdown(data);
  populateSvojstvaDropdown(data);
  wirePrefiksiClick(data);

  if (curie) displayPropertyDetails(curie, data);
  if (classId && !section) displayClassDetails(classId, data);
  if (classId && section === 'svojstva') displayPropertiesForClassOnPropertyPage(classId, data);
}

(function init(){
  if (isLocalStorageAvailable()){
    const cached = localStorage.getItem('ontologyData');
    if (cached){
      try { bootstrap(JSON.parse(cached)); return; } catch(e){}
    }
  }
  fetch('KAMOntologija_v12.jsonld')   /* koristi isti fajl kao index.html */
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(data => { try{localStorage.setItem('ontologyData', JSON.stringify(data));}catch(e){} bootstrap(data); })
    .catch(() => {
      fetch('KAMOntologija_v9.jsonld')
        .then(r => r.json())
        .then(data => { try{localStorage.setItem('ontologyData', JSON.stringify(data));}catch(e){} bootstrap(data); })
        .catch(err => {
          console.error('Ne mogu dohvatiti ontologiju:', err);
          document.getElementById('content').innerHTML = '<p>Pogreška u dohvaćanju ontologije.</p>';
        });
    });
})();
</script>

</body>
</html>
