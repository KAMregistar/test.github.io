<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KAM Ontology Property</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400&family=Rubik:wght@300&display=swap" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css"/>
  <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>

  <!-- Važno: koristi isti style.css kao index.html (u njemu je .dropdown hover ponašanje) -->
  <link rel="stylesheet" type="text/css" href="style.css">

  <style>
    /* Styling the first table (property details) */
    #propertyTable { width:100%; border-collapse: collapse; }
    #propertyTable td { padding:8px; border:1px solid #ddd; }
    #propertyTable tr:first-child td { border-top:1px solid #ddd; }
    #propertyTable tr:last-child  td { border-bottom:1px solid #ddd; }
    #propertyTable td:first-child { width:15%; font-weight:bold; }
  </style>
</head>
<body>

<!-- NAV BAR sa stvarnim dropdown kontejnerima -->
<div id="menu-bar">
  <img src="kam.png" alt="KAM Logo" class="logo">

  <h1>
    <a href="index.html" style="text-decoration:none; color:inherit;">Registar</a>
  </h1>

  <!-- KLASE -->
  <div>
    KLASE
    <div class="dropdown" id="klase-dropdown"></div>
  </div>

  <!-- SVOJSTVA -->
  <div>
    SVOJSTVA
    <div class="dropdown" id="svojstva-dropdown"></div>
  </div>

  <!-- PREFIKSI -->
  <div id="prefiksi">
    PREFIKSI
    <div class="dropdown" id="prefiksi-dropdown"></div>
  </div>

  <div>
    <a href="index.html" onclick="redirectToIndex('pomoc'); return false;">Pomoć</a>
  </div>
</div>

<div id="content">
  <p>Detalji za CURIE entitet.</p>
</div>

<!-- Footer -->
<div id="footer">
  © 2024 Nacionalna i sveučilišna knjižnica u Zagrebu. Sva prava pridržana. | Hrvatske bratske zajednice 4, 10000 Zagreb, Hrvatska | Tel. +385 1 616 4021
</div>

<script>
/* ------------------ Navigacija natrag na index s parametrima ------------------ */
function redirectToIndex(section) {
  const urlParams = new URLSearchParams(window.location.search);
  const curie = urlParams.get('curie');
  if (section === 'klase' || section === 'svojstva' || section === 'prefiksi' || section === 'pomoc') {
    window.location.href = `index.html?section=${section}&curie=${curie}`;
  } else {
    window.location.href = `index.html?curie=${curie}`;
  }
}

/* ------------------ Pomoćne funkcije (download, datumi, linkovi) ------------------ */
function generateDownloadLinks(curie) {
  const className = (curie.split(':')[1] || '').toLowerCase().replace(/ /g, '_');
  const jsonLdLink = `ontology_elements_${className}.jsonld`;
  const csvLink    = `ontology_elements_${className}.csv`;
  const rdfXmlLink = `ontology_elements_${className}.rdf`;
  return `
    <table>
      <tr>
        <td>Preuzimanja:</td>
        <td><a href="${jsonLdLink}" download>JSON-LD</a></td>
        <td><a href="${csvLink}"    download>CSV</a></td>
        <td><a href="${rdfXmlLink}" download>RDF/XML</a></td>
      </tr>
    </table>`;
}

function getLastModifiedDate() {
  const lastModified = document.lastModified;
  return `<table><tr><td>Posljednja izmjena: ${lastModified}</td></tr></table>`;
}

function makeClickableLink(uri) {
  return uri ? `<a href="${uri}" target="_blank">${uri}</a>` : '';
}

/* ------------------ Prikaz detalja svojstva ------------------ */
function displayPropertyDetails(curie, data) {
  const content = document.getElementById('content');
  const property = Object.values(data).find(item =>
    item['http://www.registar.kam.hr/ontologies/ont.owl/ID']
    && item['http://www.registar.kam.hr/ontologies/ont.owl/ID'][0]['@value'] === curie
  );

  if (!property) {
    content.innerHTML = '<p>Details not found for the selected CURIE.</p>';
    return;
  }

  const label = property['http://www.w3.org/2000/01/rdf-schema#label']
    ? property['http://www.w3.org/2000/01/rdf-schema#label'][0]['@value'] : '';

  const definition = property['http://www.registar.kam.hr/ontologies/ont.owl/definition']
    ? property['http://www.registar.kam.hr/ontologies/ont.owl/definition'][0]['@value'] : '';

  const domain = property['http://www.w3.org/2000/01/rdf-schema#domain']?.[0]
    ? makeClickableLink(property['http://www.w3.org/2000/01/rdf-schema#domain'][0]['@id']) : '';

  const range = property['http://www.w3.org/2000/01/rdf-schema#range']?.[0]
    ? makeClickableLink(property['http://www.w3.org/2000/01/rdf-schema#range'][0]['@id']) : '';

  const subPropertyOf = property['http://www.w3.org/2000/01/rdf-schema#subPropertyOf']?.[0]
    ? makeClickableLink(property['http://www.w3.org/2000/01/rdf-schema#subPropertyOf'][0]['@id']) : '';

  const inverseOf = property['http://www.w3.org/2002/07/owl#inverseOf']?.[0]
    ? makeClickableLink(property['http://www.w3.org/2002/07/owl#inverseOf'][0]['@id'])
    : 'Ne postoji <i>inverseOf</i>';

  content.innerHTML = `<h2>Detalji za: "${label}"</h2>`;
  let table = `
    <table id="propertyTable" class="display">
      <tbody>
        <tr><td>KAM ID</td><td>${curie}</td></tr>
        <tr><td>Naziv</td><td>${label}</td></tr>
        <tr><td>Definicija</td><td>${definition}</td></tr>
        <tr><td>Domena</td><td>${domain}</td></tr>
        <tr><td>Doseg</td><td>${range}</td></tr>
        <tr><td>Obrnuto od</td><td>${inverseOf}</td></tr>
        <tr><td>Podsvojstvo od</td><td>${subPropertyOf}</td></tr>
      </tbody>
    </table>`;

  content.innerHTML += table;
  content.innerHTML += generateDownloadLinks(curie);
  content.innerHTML += getLastModifiedDate();

  $(document).ready(function() {
    $('#propertyTable').DataTable({
      paging:false, info:false, searching:false, ordering:false
    });
  });
}

/* ------------------ Dropdown popunjavanje (iste ideje kao na indexu) ------------------ */
function populateKlaseDropdown(data) {
  const dd = document.getElementById('klase-dropdown');
  dd.innerHTML = '';
  Object.values(data).forEach(el => {
    const isClass = el['@type']?.includes('http://www.w3.org/2002/07/owl#Class');
    if (!isClass) return;
    const lbl = el['http://www.w3.org/2000/01/rdf-schema#label']?.[0]?.['@value']
              || el['@id']?.split('/').pop();
    const item = document.createElement('div');
    item.textContent = lbl;
    item.onclick = () => window.location.href = `index.html?class=${encodeURIComponent(el['@id'])}`;
    dd.appendChild(item);
  });
}

function populateSvojstvaDropdown(data) {
  const dd = document.getElementById('svojstva-dropdown');
  dd.innerHTML = '';
  Object.values(data).forEach(el => {
    const isProperty = el['@type']?.includes('http://www.w3.org/2002/07/owl#ObjectProperty')
                    || el['@type']?.includes('http://www.w3.org/2002/07/owl#DatatypeProperty')
                    || el['@type']?.includes('http://www.w3.org/2002/07/owl#AnnotationProperty');
    if (!isProperty) return;
    const lbl = el['http://www.w3.org/2000/01/rdf-schema#label']?.[0]?.['@value']
              || el['@id']?.split('/').pop();
    const item = document.createElement('div');
    item.textContent = lbl;
    // vodi na property stranicu s curie ili id parametrom po potrebi
    item.onclick = () => window.location.href = `property.html?curie=${encodeURIComponent(el['http://www.registar.kam.hr/ontologies/ont.owl/ID']?.[0]?.['@value'] || '')}`;
    dd.appendChild(item);
  });
}

function populatePrefiksiDropdown(data) {
  const dd = document.getElementById('prefiksi-dropdown');
  dd.innerHTML = '';
  const seen = new Set();
  Object.values(data).forEach(el => {
    const curie = el['http://www.registar.kam.hr/ontologies/ont.owl/ID']?.[0]?.['@value'];
    if (!curie || !curie.includes(':')) return;
    const prefix = curie.split(':')[0];
    if (seen.has(prefix)) return;
    seen.add(prefix);
    const item = document.createElement('div');
    item.textContent = prefix;
    dd.appendChild(item);
  });
}

/* ------------------ Dohvat JSON-LD (koristi isti fajl kao na indexu) ------------------ */
function isLocalStorageAvailable() {
  try { const t='__ls__'; localStorage.setItem(t,t); localStorage.removeItem(t); return true; }
  catch(e){ return false; }
}

const urlParams = new URLSearchParams(window.location.search);
const curie = urlParams.get('curie');

function bootstrap(data) {
  // popuni dropdown menije
  populateKlaseDropdown(data);
  populateSvojstvaDropdown(data);
  populatePrefiksiDropdown(data);
  // prikaži detalje svojstva
  if (curie) displayPropertyDetails(curie, data);
}

(function init(){
  if (isLocalStorageAvailable()) {
    const cached = localStorage.getItem('ontologyData');
    if (cached) {
      try { bootstrap(JSON.parse(cached)); return; } catch(e){}
    }
  }
  // Ako nema u LS-u, fetchaj fajl — promijeni naziv ako koristiš drugi (npr. KAMOntologija_v9test.jsonld)
  fetch('KAMOntologija_v12.jsonld')
    .then(r => { if(!r.ok) throw new Error('Greška HTTP'); return r.json(); })
    .then(data => {
      try { if (isLocalStorageAvailable()) localStorage.setItem('ontologyData', JSON.stringify(data)); } catch(e){}
      bootstrap(data);
    })
    .catch(err => {
      console.error('Pogreška pri dohvaćanju ontologije:', err);
      if (curie) document.getElementById('content').innerHTML = '<p>Pogreška u dohvaćanju ontologije.</p>';
    });
})();
</script>

</body>
</html>
